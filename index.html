<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>SharpNative by afrogeek</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>SharpNative</h1>
        <p>A C# to Native Code (C++, D etc...) Transpiler based on Microsoft Roslyn</p>

        <p class="view"><a href="https://github.com/afrogeek/SharpNative">View the Project on GitHub <small>afrogeek/SharpNative</small></a></p>


        <ul>
          <li><a href="https://github.com/afrogeek/SharpNative/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/afrogeek/SharpNative/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/afrogeek/SharpNative">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a id="what-is-sharpnative-" class="anchor" href="#what-is-sharpnative-" aria-hidden="true"><span class="octicon octicon-link"></span></a>What is SharpNative ?</h1>

<p>SharpNative is a tool that generates <strong>Native Code</strong> (D, Soon C++11, Java and Swift) from <strong>C#</strong> leveraging Microsoft Roslyn to generate almost hand-written code the the target languages.</p>

<p>The idea is to maximize the cross-platform capabilities of C# without being tied to any vendor or platform. The Emphasis here is on Performance and Readability of the generated D Code. Comments are preserved as well.</p>

<hr>

<h3>
<a id="supported-output-languages" class="anchor" href="#supported-output-languages" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Supported Output Languages</strong>
</h3>

<p>The Compiler in its current state only supports D as the output language. (This is due to DMD being an extremely fast compiler, so testing features is fun)</p>

<hr>

<h3>
<a id="performance----these-are-very-unscientific" class="anchor" href="#performance----these-are-very-unscientific" aria-hidden="true"><span class="octicon octicon-link"></span></a>
<strong>Performance</strong> -- <em>These are very unscientific</em>
</h3>

<p>The following are tests taken from CrossNet (one of the first C# to Native compiler efforts)</p>

<p><strong>Machine:</strong></p>

<p>-- Macbook Pro Retina (Mid 2012)</p>

<p>-- 2.6Ghz Intel Core i7</p>

<p>-- 16GB  1600 MHz DDR3</p>

<p>Some benchmarks on my Parallels Windows 8 VM: (3GB Ram, 3 Cores) using DMD  with options  <code>-inline -release -m64 -O</code>
and .Net in release mode</p>

<table>
<thead>
<tr>
<th>Type Of Test</th>
<th align="center">C# Time (ms)</th>
<th align="left">D Time (ms)</th>
<th align="right">Speed Ratio (C#/D)</th>
</tr>
</thead>
<tbody>
<tr>
<td>NSieveTest</td>
<td align="center">18859</td>
<td align="left">5450</td>
<td align="right">3.46x</td>
</tr>
<tr>
<td>MatrixTest(MultiDimensional)</td>
<td align="center">12359</td>
<td align="left">22606</td>
<td align="right">0.56x</td>
</tr>
<tr>
<td>MatrixTest(Jagged)</td>
<td align="center">10156</td>
<td align="left">2580</td>
<td align="right">3.98x</td>
</tr>
<tr>
<td>GC Test</td>
<td align="center">10657</td>
<td align="left">57288</td>
<td align="right">0.19x</td>
</tr>
<tr>
<td>Unsafe Test</td>
<td align="center">32375</td>
<td align="left">4752</td>
<td align="right">6.81x</td>
</tr>
<tr>
<td>HeapSort Test</td>
<td align="center">8671</td>
<td align="left">3906</td>
<td align="right">2.21x</td>
</tr>
<tr>
<td>Average</td>
<td align="center"></td>
<td align="left"></td>
<td align="right"><strong>2.87x</strong></td>
</tr>
</tbody>
</table>

<p>Due to the produced binaries being native and better optimizations in the DMD, the generated binaries are generally much faster than their C# counterparts. Except when Garbage Collection is concerned, the D GC is much slower than that of .Net (Maybe we can port it to D). Also the current multidimensional array implementation seems lacking in performance.</p>

<hr>

<p>Example of Generated Code</p>

<p>C#:</p>

<div class="highlight highlight-c++"><pre><span class="pl-k">using</span> System;

<span class="pl-k">class</span> <span class="pl-en">Primes</span>
{
    public <span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">Main</span>()
    {
        var len = <span class="pl-c1">1000000</span>; <span class="pl-c">// This is a comment</span>
        var primes = <span class="pl-c1">AddPrimes</span>(len);
        Console.<span class="pl-c1">Write</span>(primes);
    }

    private <span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">AddPrimes</span>(<span class="pl-k">int</span> len)
    {
        var primes = <span class="pl-c1">0</span>;
        <span class="pl-k">for</span> (var i = <span class="pl-c1">2</span>; i &lt; len; i++)
        {
            <span class="pl-k">if</span> (i%<span class="pl-c1">2</span> == <span class="pl-c1">0</span>)
                <span class="pl-k">continue</span>;
            var isPrime = <span class="pl-c1">true</span>;
            <span class="pl-k">for</span> (var j = <span class="pl-c1">2</span>; j*j &lt;= i; j++)
            {
                <span class="pl-k">if</span> (i%j == <span class="pl-c1">0</span>)
                {
                    isPrime = <span class="pl-c1">false</span>;
                    <span class="pl-k">break</span>;
                }
            }
            <span class="pl-k">if</span> (isPrime)
                primes++;
        }
        <span class="pl-k">return</span> primes;
    }

}<span class="pl-ii"></span></pre></div>

<p>D:</p>

<div class="highlight highlight-d"><pre><span class="pl-k">module</span> <span class="pl-en">CsRoot.Primes</span>;
<span class="pl-k">import</span> <span class="pl-k">System</span>.<span class="pl-k">Namespace</span>;
<span class="pl-k">import</span> <span class="pl-k">CsRoot</span>.<span class="pl-k">Namespace</span>;

<span class="pl-k">class</span> <span class="pl-en">Primes</span> : <span class="pl-e">NObject</span>
{

    <span class="pl-k">public static </span><span class="pl-k">void</span> <span class="pl-en">Main</span>()
    {
      <span class="pl-k">int</span> len = <span class="pl-c1">1000000</span>;
      <span class="pl-c">// This is a comment</span>
      <span class="pl-k">int</span> primes = <span class="pl-k">AddPrimes</span>(len);
      <span class="pl-c1">Console</span>.<span class="pl-k">Write</span>(primes);
    }

    <span class="pl-k">final static </span><span class="pl-k">int</span> <span class="pl-en">AddPrimes</span>(<span class="pl-k">int</span> len)
    {
      <span class="pl-k">int</span> primes = <span class="pl-c1">0</span>;

      <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">2</span>;i<span class="pl-k">&lt;</span>len;i<span class="pl-k">++</span>)
      {
        <span class="pl-k">if</span>(i<span class="pl-k">%</span><span class="pl-c1">2</span><span class="pl-k">==</span><span class="pl-c1">0</span>)
        {
          <span class="pl-k">continue</span>;
        }
        <span class="pl-k">bool</span> isPrime = <span class="pl-c1">true</span>;

        <span class="pl-k">for</span> (<span class="pl-k">int</span> j = <span class="pl-c1">2</span>;j<span class="pl-k">*</span>j<span class="pl-k">&lt;=</span>i;j<span class="pl-k">++</span>)
        {
          <span class="pl-k">if</span>(i<span class="pl-k">%</span>j<span class="pl-k">==</span><span class="pl-c1">0</span>)
          {
            isPrime=<span class="pl-c1">false</span>;
            <span class="pl-k">break</span>;
          }
        }
        <span class="pl-k">if</span>(isPrime)
        {
          primes<span class="pl-k">++</span>;
        }
      }
      <span class="pl-k">return</span> primes;
    }

  <span class="pl-k">public</span> <span class="pl-k">override</span> <span class="pl-k">String</span> <span class="pl-k">ToString</span>()
  {
    <span class="pl-k">return</span> <span class="pl-k">GetType</span>().<span class="pl-k">FullName</span>;
  }

  <span class="pl-k">public</span> <span class="pl-k">override</span> <span class="pl-k">Type</span> <span class="pl-k">GetType</span>()
  {
    <span class="pl-k">return</span> __TypeOf<span class="pl-k">!</span>(<span class="pl-k">typeof</span>(<span class="pl-v">this</span>));
  }
}</pre></div>

<hr>

<h3>
<a id="documentation" class="anchor" href="#documentation" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Documentation</strong>
</h3>

<p>Unfortunately this is all the documentation the transpiler has at the moment.</p>

<hr>

<p><strong>Feature List (Incomplete):</strong></p>

<ul>
<li>  What works: </li>
<li>  Basic PInvoke including marshalling</li>
<li>  Arrays including initializers</li>
<li>  Fields/ Properties/Methods with correct hiding semantics</li>
<li>  Properties</li>
<li>  String</li>
<li>  Int/Double/Bool</li>
<li>  Classes and Polymorphism … we follow C# model</li>
<li>  Some benchmarks - basic linpack, fannkuch, nbody</li>
<li>  Modules/Namespaces</li>
<li>  Enum - no enum.Parse support yet though</li>
<li>  Iterators are as .Net use enumerators etc … switching arrays to use simple for loop though for performance improvement</li>
<li>  Constructors/Overloads/Base Class calls</li>
<li>  Static Variables/Members/Properties</li>
<li>  Basic System.Math, more implementations required though</li>
<li>  Extension Methods</li>
<li>  Operator Overloading</li>
<li>  Indexers</li>
<li>  Anonymous Classes</li>
<li>  Generics … All current test cases work</li>
<li>  Boxed structs and interface casting for them</li>
<li>  Inner Classes in the form of OuterClass_InnerClass</li>
<li>  Static Constructors</li>
<li>  Explicit Interfaces</li>
<li>  Implicit and Explicit Cast Operators</li>
<li>  String switch … dlang supports this natively :)</li>
<li>  String.Format .. though implementation is very basic</li>
<li>  C# multi dimensional arrays work correctly (even with multi dim syntax :) )</li>
<li>  Delegates work including multicast (Native delegates through P/Invoke work too)</li>
<li>  Events work as expected … though a bit slower than C#(mono)</li>
<li>  Object initializers work as a chain of lambda expressions</li>
<li>  Generic Virtual Methods</li>
<li>  Basic Reflection of Methods, Fields and Properties, IndexerProperties are not yet supported as are Generic Methods ... for now.</li>
<li>  Iterators and Yield using code from WootzJS, a fiber implementation exists but it crashes on DMD 2.066 Windows 64-bit</li>
</ul>

<hr>

<h3>
<a id="requirements----testing" class="anchor" href="#requirements----testing" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Requirements -- Testing</strong>
</h3>

<p>-- Microsoft .Net 4.0 / Mono 3.6 and above.</p>

<p>-- Windows 7 or Later ( The CLI Interface works on Linux and OSX)</p>

<p>-- A Working D Installation  (LDC,DMD or GDC) </p>

<h3>
<a id="requirements----development" class="anchor" href="#requirements----development" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Requirements -- Development</strong>
</h3>

<p>All requirements mentioned above and:</p>

<p>-- Visual Studio 2013 or above</p>

<p>-- Visual D </p>

<h3>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Usage</strong>
</h3>

<p>If you are using the GUI interface(windows) note that DMD should be installed in <code>"C:\\D\\dmd2\\windows\\bin\\"</code> 
For the CLI interface the driver can be invoked in the following manner:</p>

<pre><code>mono ./SharpNative.exe /compiler:pathtodcompiler /dcorlib:/**pathtodcorlib** /source:"pathtosourcefile" /outputtype:exe /dstdlib:pathtophobos /compileroptions:"compileroptions"
</code></pre>

<p><strong>where</strong>:</p>

<p>-- <strong>pathtodcompiler</strong> is the path to a d compiler e.g. <code>/usr/local/bin/ldc</code> on mac osx</p>

<p>-- <strong>pathtodcorlib</strong> is the path to the included basic corlib e.g. <code>/Projects/SharpNative/DCorlib</code></p>

<p>-- <strong>pathtosourcefile</strong> is the path to the test source file in C#</p>

<p>--<strong>pathtophobos</strong> is the location of phobos in your installation e.g. <code>/usr/local/Cellar/ldc/0.15.0/include/d</code></p>

<p>--<strong>compileroptions</strong> are the compiler options to pass to dmd/ldc/gdc e.g. <code>-inline -release -m64 -O5 -oq</code></p>

<p><strong>What Doesn’t Work: (Also Incomplete)</strong></p>

<ul>
<li>  Right now compiler does not do any optimizations like final, in, out <a href="https://github.com/pure" class="user-mention">@pure</a> etc …</li>
<li>  Async/Await - Working on an implementation</li>
<li>  Query Expression Syntax for LINQ and Expression Trees</li>
<li>  Structs FieldLayout implementation is currently wrong ... to mimic C# a new design is needed.</li>
</ul>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/afrogeek">afrogeek</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>